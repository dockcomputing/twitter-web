<ng-container
  [cignaTrackInit]="['trackActivityHistoryPage']"
  *cignaResponsive="let screen"
>
  <cigna-skip-links [isFooterDisabled]="true"></cigna-skip-links>

  <ng-container
    *ngIf="isShowFilter && screen.isSmallerOrEqual('md'); else activityHistory"
  >
    <cigna-mobile-filter-view
      [sortByList]="[
        'msk.activities.filterDateCompleted' | translate,
        'msk.activities.sortName' | translate
      ]"
      [applyButtonText]="'msk.activities.filterApply' | translate"
      [sortSelected]="sortSelection"
      (sortEvent)="sortCards($event)"
      (closeFilter)="onCloseFilter()"
    ></cigna-mobile-filter-view>
  </ng-container>
  <ng-template #activityHistory>
    <ng-container *cignaWaitToLoad="cards$; let cards">
      <div class="history-page-container">
        <cigna-global-header
          class="global-header"
          (leftBackButtonClick)="onBack()"
          [title]="'msk.activities.activityHistory' | translate"
        >
          <ng-template rightContent>
            <button
              *ngIf="!screen.isLargerOrEqual('lg')"
              aria-label="Filter"
              class="filter-button"
              type="button"
              (click)="isShowFilter = true"
            >
              <span class="icon">
                <cigna-icon class="filter-icon" type="filter"></cigna-icon>
              </span>
            </button>
          </ng-template>
        </cigna-global-header>
        <main class="skip-target-main-content" role="main" tabindex="-1">
          <div
            class="history-page-content"
            [ngClass]="{ 'no-activity-container': !cards.length }"
          >
            <div *ngIf="!screen.isSmallerOrEqual('md')" class="filter-bar">
              <div *ngIf="!screen.isSmallerOrEqual('md')" class="sort-buttons">
                <span>{{ 'action.sortLabel' | translate }}</span>
                <button
                  class="filter-button"
                  data-test-id="button-sort-date"
                  type="button"
                  [attr.aria-pressed]="
                    isFilterChange || sortSelection === SortValue.DATE
                  "
                  [cignaButton]="
                    sortSelection === SortValue.DATE ? 'primary' : 'secondary'
                  "
                  (click)="sortCards(SortValue.DATE)"
                >
                  {{ 'global.dateLabel' | translate }}
                </button>
                <button
                  class="filter-button"
                  data-test-id="button-sort-name"
                  type="button"
                  [attr.aria-pressed]="
                    isFilterChange || sortSelection === SortValue.NAME
                  "
                  [cignaButton]="
                    sortSelection === SortValue.NAME ? 'primary' : 'secondary'
                  "
                  (click)="sortCards(SortValue.NAME)"
                >
                  {{ 'global.nameLabel' | translate }}
                </button>
              </div>
            </div>
            <div
              class="stats-container"
              [ngClass]="{ 'no-bottom-border': !cards.length }"
            >
              <h1 class="screen-reader-text">Activity History</h1>
              <h2 class="stat-title" data-test-id="completed-activities-title">
                {{ 'msk.activities.complAct' | translate }}
              </h2>
              <p class="stat-number" data-test-id="completed-activities-number">
                {{ cards.length }}
              </p>
            </div>

            <div
              *ngIf="cards.length; else noCompletedActivityScreen"
              class="timeline-container"
            >
              <h2 class="title" data-test-id="timeline-title">
                {{
                  sortSelection === SortValue.DATE
                    ? ('msk.activities.timelineLabel' | translate)
                    : ('msk.activities.sortAtoZ' | translate)
                }}
              </h2>
              <ul class="history-cards">
                <div
                  class="dotted-spaced"
                  [ngClass]="{
                    'hide-dotted-line': sortSelection !== SortValue.DATE
                  }"
                ></div>
                <li
                  class="timeline-card-wrapper"
                  *ngFor="let card of cards; let index = index"
                >
                  <div class="row-flex">
                    <div
                      class="card-status-wrapper"
                      [ngClass]="{
                        'align-center':
                          index !== 0 && index !== cards.length - 1
                      }"
                    >
                      <div
                        class="dotted-place-holder"
                        *ngIf="index === 0 || index === cards.length - 1"
                        [ngClass]="{ overlap: index === 0 }"
                      ></div>
                      <img
                        class="card-completed-icon overlap"
                        role="presentation"
                        src="assets/images/care-path/checked_circle.svg"
                        *ngIf="card.isCompleted"
                      />
                      <div
                        class="dotted-place-holder"
                        *ngIf="index === 0 || index === cards.length - 1"
                        [ngClass]="{ overlap: index === cards.length - 1 }"
                      ></div>
                    </div>
                    <div
                      class="timeline-card"
                      [ngClass]="{ completed: card.isCompleted }"
                    >
                      <div class="card-info" [id]="'card-info-' + index">
                        <h3 class="card-title" data-test-id="card-title">
                          {{ card.title }}
                        </h3>
                        <div class="card-type" data-test-id="card-type">
                          <img
                            class="card-icon"
                            role="presentation"
                            [src]="card.typeIcon"
                            data-test-id="image-card-type-icon"
                          />
                          {{ card.type }}
                        </div>
                        <div class="card-duration" data-test-id="card-duration">
                          <div
                            class="duration-info"
                            data-test-id="card-duration-info"
                          >
                            <img
                              class="card-icon"
                              role="presentation"
                              src="assets/images/care-path/duration_icon.svg"
                              data-test-id="image-card-duration-icon"
                            />
                            {{ card.duration }}
                          </div>
                          <cigna-icon
                            *ngIf="screen.isSmallerOrEqual('md')"
                            class="right-arrow"
                            type="right-arrow"
                          ></cigna-icon>
                        </div>
                        <div
                          *ngIf="card.isCompleted"
                          class="card-completed-date"
                        >
                          <img
                            class="card-completed-icon"
                            role="presentation"
                            src="assets/images/care-path/checked_circle.svg"
                            data-test-id="image-card-completed-icon"
                          />
                          <div
                            class="bold"
                            data-test-id="card-completed-status"
                          >
                            Completed
                          </div>
                          {{ card.dateCompleted }}
                        </div>
                        <button
                          *ngIf="card.isViewable"
                          class="card-button"
                          type="button"
                          data-test-id="button-view"
                          cignaButton="primary"
                          (click)="onActivityClick(card.actionDefinitionId)"
                        >
                          {{ 'msk.activities.viewRedo' | translate }}
                        </button>
                      </div>
                      <div
                        class="card-image"
                        [ngClass]="{ 'button-viewable': card.isViewable }"
                      >
                        <img
                          *ngIf="card.imgSource"
                          role="presentation"
                          [src]="card.imgSource | cdnPrefix"
                          data-test-id="image-card-activity"
                        />
                      </div>
                    </div>
                  </div>
                  <div class="card-spacer"></div>
                </li>
              </ul>
            </div>

            <ng-template #noCompletedActivityScreen>
              <p class="no-activities-text" data-test-id="no-activities">
                {{ 'msk.activities.getActivityStarted' | translate }}
              </p>
            </ng-template>
          </div>
        </main>
      </div>
    </ng-container>
  </ng-template>
</ng-container>
